

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Undefined behavior and optimizations &mdash; BedRock BRiCk alpha documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/alectryon.css" type="text/css" />
  <link rel="stylesheet" href="_static/tango_subtle.min.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/justify.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/alectryon.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Pointers and pointer provenance" href="pointers.html" />
    <link rel="prev" title="Evaluation" href="evaluation.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> BedRock BRiCk
          

          
          </a>

          
            
            
              <div class="version">
                0.5.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="features.html">Language Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="evaluation.html">Evaluation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Undefined behavior and optimizations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#a-minimal-example">A minimal example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="pointers.html">Pointers and pointer provenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="object_layout.html">Object representation, layout and padding</a></li>
<li class="toctree-l1"><a class="reference internal" href="machine.html">Assembly Interoperation</a></li>
<li class="toctree-l1"><a class="reference internal" href="documentation.html">Code Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="bibliography.html">Related work and bibliography</a></li>
<li class="toctree-l1"><a class="reference internal" href="acknowledgements.html">Acknowledgements</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">BedRock BRiCk</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Undefined behavior and optimizations</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/undefined_behavior.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="undefined-behavior-and-optimizations">
<span id="undefined-behavior"></span><h1>Undefined behavior and optimizations<a class="headerlink" href="#undefined-behavior-and-optimizations" title="Permalink to this headline">¶</a></h1>
<p>C++ programmers want compilers to produce fast code without exploiting undefined
behavior. But that is impossible, so (optimizing) compilers opt to produce fast
code instead. Hence, to formally verify C++ programs are correct, we must prevent
programs from having UB.</p>
<p>This page motivates informally the need for some UB, by showing that exploiting
UB is necessary even for obvious optimizations. You are welcome to skip this
page, but it will give intuition for other content in this guide.</p>
<p>We assume you are familiar with programming in C++.</p>
<div class="section" id="a-minimal-example">
<h2>A minimal example<a class="headerlink" href="#a-minimal-example" title="Permalink to this headline">¶</a></h2>
<p>We show undefined behavior on an example. For clarity, we pick a small example.
This example might seem artificial, but it shows issues that affect real
programs.</p>
<p>In the snippet below, the function <code class="code highlight coq docutils literal notranslate"><span class="n"><span class="pre">foo</span></span></code> seems equivalent to
<code class="code highlight coq docutils literal notranslate"><span class="n"><span class="pre">foo_opt</span></span></code><a class="footnote-reference brackets" href="#provenance-example" id="id1">1</a>, but the latter can avoid re-reading <code class="code highlight coq docutils literal notranslate"><span class="n"><span class="pre">x</span></span></code> from
memory, so we expect optimizers to transform the former into the latter.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">foo</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">long</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
  <span class="n">bar</span><span class="p">();</span>
  <span class="k">return</span> <span class="n">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">foo_opt</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">bar</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">5</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Indeed, whatever <code class="code highlight coq docutils literal notranslate"><span class="n"><span class="pre">bar</span></span><span class="bp"><span class="pre">()</span></span></code> does, this optimization preserves program behavior, as
defined by the C++ standard, and compilers indeed perform it.</p>
<p>However, that optimization changes the program behavior if <code class="code highlight coq docutils literal notranslate"><span class="n"><span class="pre">bar</span></span><span class="bp"><span class="pre">()</span></span></code> looks like
the following strange example:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">bar</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">long</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">long</span><span class="o">*</span> <span class="n">px</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">y</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span> <span class="c1">// &quot;5&quot; is platform-specific</span>
  <span class="o">*</span><span class="n">px</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>On our test platform<a class="footnote-reference brackets" href="#godbolt-example" id="id2">2</a>, <code class="code highlight coq docutils literal notranslate"><span class="n"><span class="pre">px</span></span></code> will contain the address of <code class="code highlight coq docutils literal notranslate"><span class="n"><span class="pre">x</span></span></code>,
so without optimizations <code class="code highlight coq docutils literal notranslate"><span class="n"><span class="pre">foo</span></span><span class="bp"><span class="pre">()</span></span></code> will return <code class="code highlight coq docutils literal notranslate"><span class="mi"><span class="pre">4</span></span></code>; but with the optimization
above, <code class="code highlight coq docutils literal notranslate"><span class="n"><span class="pre">foo</span></span><span class="bp"><span class="pre">()</span></span></code> returns <code class="code highlight coq docutils literal notranslate"><span class="mi"><span class="pre">5</span></span></code>.</p>
<p>We claimed our optimization preserves program behavior, yet it appears to change
<code class="code highlight coq docutils literal notranslate"><span class="n"><span class="pre">foo</span></span><span class="bp"><span class="pre">()</span></span></code>’s return value; how is that possible?
At the same time, this optimization is desirable; and if this small optimization
were illegal, would we have a chance to perform more complex optimizations?</p>
<p>As a solution, the C++ standard ensures that <code class="code highlight coq docutils literal notranslate"><span class="n"><span class="pre">bar</span></span><span class="bp"><span class="pre">()</span></span></code> contains <em>undefined
behavior</em> (UB), and allows programs to implement undefined behavior arbitrarily.
In particular, <code class="code highlight coq docutils literal notranslate"><span class="n"><span class="pre">bar</span></span><span class="bp"><span class="pre">()</span></span></code> is UB because it takes a pointer to a variable (<code class="code highlight coq docutils literal notranslate"><span class="n"><span class="pre">y</span></span></code>),
increments it until it has the address of another variable (<code class="code highlight coq docutils literal notranslate"><span class="n"><span class="pre">x</span></span></code>), then writes
through this pointer.</p>
<p class="rubric">Footnotes</p>
<dl class="footnote brackets">
<dt class="label" id="provenance-example"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>Based on <a class="reference external" href="https://web.archive.org/web/20210819142604/https://news.ycombinator.com/item?id=27562962">this example</a>.</p>
</dd>
<dt class="label" id="godbolt-example"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd><p>At least on a specific compiler, according to <a class="reference external" href="https://godbolt.org/z/8cha4Ebfo">Godbolt</a>.</p>
</dd>
</dl>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="pointers.html" class="btn btn-neutral float-right" title="Pointers and pointer provenance" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="evaluation.html" class="btn btn-neutral float-left" title="Evaluation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021 BedRock Systems.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>